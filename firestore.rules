rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ヘルパー関数
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidDate(dateString) {
      return dateString is string
        && dateString.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }

    function isValidEntry(data) {
      return data.keys().hasAll(['date', 'goal', 'reality', 'actions', 'statusNote', 'evidence', 'reflection', 'createdAt', 'updatedAt'])
        && isValidDate(data.date)
        && data.goal is map
        && data.goal.keys().hasAll(['title', 'detail'])
        && data.reality is string
        && data.actions is list
        && data.actions.size() <= 50  // アクション数の制限
        && data.statusNote is string
        && data.evidence is string
        && data.reflection is string
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }

    function isValidTextLength(text) {
      return text.size() <= 10000;  // 10KB制限
    }

    function isValidAction(action) {
      return action is map
        && action.keys().hasAll(['id', 'text', 'status'])
        && action.text is string
        && action.text.size() <= 10000
        && action.status is string
        && action.status in ['todo', 'doing', 'done'];
    }

    function allActionsValid(actions) {
      return actions.size() == 0 || actions.hasAll([true]);
    }

    // ユーザーデータへのアクセスルール
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId);
      allow delete: if false;

      match /entries/{entryId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId)
                      && isValidEntry(request.resource.data)
                      && isValidTextLength(request.resource.data.goal.title)
                      && isValidTextLength(request.resource.data.goal.detail)
                      && isValidTextLength(request.resource.data.reality)
                      && isValidTextLength(request.resource.data.statusNote)
                      && isValidTextLength(request.resource.data.evidence)
                      && isValidTextLength(request.resource.data.reflection);

        allow update: if isOwner(userId)
                      && isValidEntry(request.resource.data)
                      && isValidTextLength(request.resource.data.goal.title)
                      && isValidTextLength(request.resource.data.goal.detail)
                      && isValidTextLength(request.resource.data.reality)
                      && isValidTextLength(request.resource.data.statusNote)
                      && isValidTextLength(request.resource.data.evidence)
                      && isValidTextLength(request.resource.data.reflection)
                      && request.resource.data.createdAt == resource.data.createdAt
                      && request.resource.data.date == resource.data.date;

        allow delete: if isOwner(userId);
      }
    }

    // その他のパスへのアクセスは全て拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
