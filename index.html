<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>æ—¥æ¬¡ ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ</title>

  <!-- PWA Meta -->
  <meta name="description" content="ãƒ¢ãƒã‚¤ãƒ«ã§æ¯æ—¥5ã€œ10åˆ†ã®å…¥åŠ›â†’ä¿å­˜â†’ç¿’æ…£åŒ–ã€‚ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆã§ç›®æ¨™é”æˆã‚’å¯è¦–åŒ–ã€‚">
  <meta name="theme-color" content="#6366F1">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- iOS Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ç·Šå¼µæ§‹é€ ">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK v9+ (modular) -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB18zaPHFs16shy8XMctOMPGCUWfOdUTI0",
      authDomain: "everyday645845-stchart-backend.firebaseapp.com",
      projectId: "everyday645845-stchart-backend",
      storageBucket: "everyday645845-stchart-backend.firebasestorage.app",
      messagingSenderId: "428635093712",
      appId: "1:428635093712:web:6901f2970dc4b25159fcd5",
      measurementId: "G-MVKRZPM29D"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Make Firebase available globally for the app script
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseModules = {
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      signOut,
      collection,
      doc,
      setDoc,
      getDoc,
      getDocs,
      deleteDoc,
      query,
      orderBy,
      where
    };

    // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
    window.firebaseReady = true;
    console.log('[Firebase] SDK loaded and ready');
    window.dispatchEvent(new Event('firebaseReady'));
  </script>

  <style>
    /* Tailwind Config */
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#6366F1',
              dark: '#4F46E5',
              light: '#818CF8'
            },
            accent: {
              DEFAULT: '#EC4899',
              dark: '#DB2777',
              light: '#F472B6'
            }
          }
        }
      }
    }

    /* Custom Styles */
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      overscroll-behavior-y: contain;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      }
    }

    /* App Container with frosted glass effect */
    #appContainer {
      backdrop-filter: blur(10px);
    }

    /* Focus visible for accessibility */
    *:focus-visible {
      outline: 2px solid #6366F1;
      outline-offset: 2px;
    }

    /* Bottom Navigation safe area */
    .bottom-nav {
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }

    @media (prefers-color-scheme: dark) {
      .bottom-nav {
        background: rgba(17, 24, 39, 0.95);
      }
    }

    /* Bottom CTA safe area */
    .bottom-cta {
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }

    @media (prefers-color-scheme: dark) {
      .bottom-cta {
        background: rgba(17, 24, 39, 0.95);
      }
    }

    /* Card with frosted glass */
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @media (prefers-color-scheme: dark) {
      .glass-card {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    }

    /* Timer animation */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .pulse-slow {
      animation: pulse-slow 2s ease-in-out infinite;
    }

    /* Success animation */
    @keyframes success-bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .success-bounce {
      animation: success-bounce 0.5s ease-in-out;
    }

    /* Streak badge shimmer */
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    .streak-shimmer {
      background: linear-gradient(90deg, #fbbf24 0%, #fcd34d 50%, #fbbf24 100%);
      background-size: 200% auto;
      animation: shimmer 2s linear infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (prefers-color-scheme: dark) {
      .gradient-text {
        background: linear-gradient(135deg, #818CF8 0%, #C084FC 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
    }

    /* Button gradient */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-gradient:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-gradient:active {
      transform: translateY(0);
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    /* Smooth scroll for modals */
    .modal-content {
      scroll-behavior: smooth;
    }

    /* Action item drag handle */
    .action-item {
      touch-action: pan-y;
      transition: all 0.2s ease;
    }

    .action-item:hover {
      transform: translateX(4px);
    }

    /* Card hover effect */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    /* Timer ring */
    .timer-ring {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    @media (prefers-color-scheme: dark) {
      .timer-ring {
        background: linear-gradient(135deg, #818CF8 0%, #C084FC 100%);
      }
    }

    /* Sticky Timer Bar */
    .sticky-timer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 40;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      padding: 0.75rem 1rem;
      padding-top: calc(0.75rem + env(safe-area-inset-top));
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    @media (prefers-color-scheme: dark) {
      .sticky-timer {
        background: rgba(17, 24, 39, 0.95);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
    }

    .sticky-timer.visible {
      transform: translateY(0);
    }
  </style>
</head>
<body class="text-gray-900 dark:text-gray-100 min-h-screen pb-20">

  <!-- Auth Loading Screen -->
  <div id="authLoadingScreen" class="fixed inset-0 bg-gradient-to-br from-primary to-accent flex items-center justify-center z-50">
    <div class="text-center text-white">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
      <p class="text-lg font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="hidden fixed inset-0 bg-gradient-to-br from-primary to-accent flex items-center justify-center z-50 p-4">
    <div class="max-w-md w-full glass-card rounded-2xl shadow-2xl p-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">ğŸ“Š ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ</h1>
        <p class="text-white/80">ç›®æ¨™é”æˆã‚’å¯è¦–åŒ–ã™ã‚‹ç¿’æ…£åŒ–ã‚¢ãƒ—ãƒª</p>
      </div>

      <button id="googleSignInBtn" class="w-full py-4 bg-white text-gray-900 rounded-xl font-bold text-lg min-h-[56px] shadow-lg hover:bg-gray-100 transition-colors flex items-center justify-center gap-3">
        <svg class="w-6 h-6" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Googleã§ãƒ­ã‚°ã‚¤ãƒ³
      </button>

      <p class="text-white/60 text-xs text-center mt-4">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã§ãã¾ã™</p>
    </div>
  </div>

  <!-- User Info Bar -->
  <div id="userInfoBar" class="hidden fixed top-0 left-0 right-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur-lg border-b border-gray-200 dark:border-gray-700 shadow-sm" style="padding-top: env(safe-area-inset-top);">
    <div class="max-w-2xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img id="userPhoto" class="w-8 h-8 rounded-full" alt="User" />
        <div class="text-sm">
          <div id="userName" class="font-medium text-gray-900 dark:text-white"></div>
          <div id="userEmail" class="text-xs text-gray-500 dark:text-gray-400"></div>
        </div>
      </div>
      <button id="signOutBtn" class="px-3 py-1.5 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- Install Banner -->
  <div id="installBanner" class="hidden fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-primary to-accent text-white p-4 shadow-lg" style="padding-top: calc(1rem + env(safe-area-inset-top));">
    <div class="flex items-center justify-between max-w-md mx-auto">
      <div class="flex-1">
        <p class="text-sm font-medium">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦å¿«é©ã«ä½¿ã†</p>
      </div>
      <button id="installBtn" class="ml-4 px-4 py-2 bg-white text-primary rounded-lg font-bold text-sm min-h-[44px] hover:bg-gray-100 transition-colors shadow-md">è¿½åŠ </button>
      <button id="installDismiss" class="ml-2 p-2 min-h-[44px] min-w-[44px] hover:bg-white/20 rounded-lg transition-colors font-bold" aria-label="é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </div>

  <!-- Offline Banner - Removed (online-only app) -->

  <!-- Sticky Timer Bar (shows when scrolled) -->
  <div id="stickyTimer" class="sticky-timer">
    <div class="max-w-2xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="text-xl">â±ï¸</span>
        <div id="stickyTimerDisplay" class="text-2xl font-bold text-primary">--:--</div>
      </div>
      <div class="flex gap-2">
        <button id="stickyTimerStart" class="px-3 py-1 bg-primary-dark text-white rounded-lg text-sm font-bold hover:bg-primary transition-colors shadow-md">é–‹å§‹</button>
        <button id="stickyTimerPause" class="hidden px-3 py-1 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600 transition-colors shadow-md">ä¸€æ™‚åœæ­¢</button>
        <button id="stickyTimerReset" class="px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-400 dark:border-gray-500 rounded-lg text-sm font-bold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- Main Content Container -->
  <div id="appContainer" class="max-w-2xl mx-auto" style="padding-top: 60px;">

    <!-- Tab: Today -->
    <div id="tabToday" class="tab-content p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text mb-3">ä»Šæ—¥ã®ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ</h1>
        <div id="streakDisplay" class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2 bg-primary/10 dark:bg-primary/20 px-3 py-1.5 rounded-full">
            <span class="text-xl">ğŸ”¥</span>
            <span id="currentStreak" class="font-bold text-primary">0æ—¥</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full">
            <span class="text-xl">ğŸ†</span>
            <span id="maxStreak" class="font-medium text-gray-600 dark:text-gray-400">æœ€é•· 0æ—¥</span>
          </div>
          <span id="streakBadge" class="ml-auto"></span>
        </div>
      </header>

      <!-- Timer Section -->
      <section class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</h2>
          <div class="flex gap-2">
            <button data-timer="5" class="timer-btn px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary transition-all min-h-[44px] shadow-md">5åˆ†</button>
            <button data-timer="7" class="timer-btn px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary transition-all min-h-[44px] shadow-md">7åˆ†</button>
            <button data-timer="10" class="timer-btn px-4 py-2 rounded-xl text-sm font-bold bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary transition-all min-h-[44px] shadow-md">10åˆ†</button>
          </div>
        </div>
        <div class="text-center">
          <div class="timer-ring mx-auto mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-full w-[180px] h-[180px] flex items-center justify-center">
              <div id="timerDisplay" class="text-5xl font-bold text-gray-900 dark:text-white">--:--</div>
            </div>
          </div>
          <div class="flex gap-2 justify-center">
            <button id="timerStart" class="px-6 py-3 bg-primary-dark text-white rounded-xl font-bold min-h-[44px] hover:bg-primary transition-colors shadow-lg">é–‹å§‹</button>
            <button id="timerPause" class="hidden px-6 py-3 bg-yellow-500 text-white rounded-xl font-bold min-h-[44px] hover:bg-yellow-600 transition-colors shadow-lg">ä¸€æ™‚åœæ­¢</button>
            <button id="timerReset" class="px-6 py-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-400 dark:border-gray-500 rounded-xl font-bold min-h-[44px] hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors shadow-md">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">â€»ã‚¿ã‚¤ãƒãƒ¼ã¯ç›®å®‰ã§ã™ã€‚æ™‚é–“ã‚’è¶…éã—ã¦ã‚‚å…¥åŠ›ã¯ç¶šã‘ã‚‰ã‚Œã¾ã™</p>
        </div>
      </section>

      <!-- Form -->
      <form id="chartForm" class="space-y-4">

        <!-- Goal -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ¯</span>
            <span>æˆæœç›®æ¨™</span>
          </label>
          <input type="text" id="goalTitle" placeholder="ä½•ã‚’é”æˆã—ãŸã„ã‹ï¼ˆçŸ­æ–‡ï¼‰" class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="æˆæœç›®æ¨™ã‚¿ã‚¤ãƒˆãƒ«">
          <textarea id="goalDetail" rows="2" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰" class="w-full mt-2 px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="æˆæœç›®æ¨™è©³ç´°"></textarea>
        </section>

        <!-- Reality -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“Š</span>
            <span>ç¾å®Ÿ</span>
          </label>
          <textarea id="reality" rows="3" placeholder="ä»Šã®çŠ¶æ³ã¯ï¼Ÿ" class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="ç¾å®Ÿ"></textarea>
        </section>

        <!-- Actions -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300">
              <span class="text-xl">âœ…</span>
              <span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
            </label>
            <button type="button" id="addAction" class="px-4 py-2 bg-primary-dark text-white rounded-xl text-sm font-medium min-h-[44px] hover:bg-primary transition-colors shadow-lg" aria-label="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ">+ è¿½åŠ </button>
          </div>
          <div id="actionsList" class="space-y-2"></div>
        </section>

        <!-- Status Note -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“</span>
            <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
          </label>
          <input type="text" id="statusNote" placeholder="é€²æ—çŠ¶æ³ã®ãƒ¡ãƒ¢" class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
        </section>

        <!-- Evidence -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“¸</span>
            <span>è¨¼æ‹ ãƒ»ãƒ­ã‚°</span>
          </label>
          <textarea id="evidence" rows="2" placeholder="å®Ÿè¡Œã—ãŸè¨¼æ‹ ã‚„ãƒ­ã‚°" class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="è¨¼æ‹ ãƒ»ãƒ­ã‚°"></textarea>
        </section>

        <!-- Reflection -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ’­</span>
            <span>ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„ï¼‰</span>
          </label>
          <textarea id="reflection" rows="3" placeholder="æŒ¯ã‚Šè¿”ã‚Šãƒ»æ°—ã¥ã" class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³"></textarea>
        </section>

      </form>
    </div>

    <!-- Tab: History -->
    <div id="tabHistory" class="tab-content hidden p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text mb-4">ğŸ“š å±¥æ­´</h1>
        <div class="space-y-2">
          <input type="text" id="historySearch" placeholder="ğŸ” æ¤œç´¢..." class="w-full px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="å±¥æ­´æ¤œç´¢">
          <div class="flex gap-2">
            <select id="historySortOrder" class="flex-1 px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-medium min-h-[44px] focus:border-primary transition-colors" aria-label="ä¸¦ã³é †">
              <option value="desc">æ–°ã—ã„é †</option>
              <option value="asc">å¤ã„é †</option>
            </select>
            <select id="historyFilter" class="flex-1 px-4 py-3 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-medium min-h-[44px] focus:border-primary transition-colors" aria-label="ãƒ•ã‚£ãƒ«ã‚¿">
              <option value="all">ã™ã¹ã¦</option>
              <option value="hasDone">å®Œäº†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ã‚Š</option>
            </select>
          </div>
        </div>
      </header>
      <div id="historyList" class="space-y-3"></div>
    </div>

    <!-- Tab: Settings -->
    <div id="tabSettings" class="tab-content hidden p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text">âš™ï¸ è¨­å®š</h1>
      </header>

      <section class="space-y-4">

        <!-- Reminder -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h2>
          <div class="space-y-3">
            <div>
              <button id="testNotification" class="w-full px-4 py-3 bg-primary text-white rounded-xl font-bold min-h-[44px] hover:bg-primary-dark transition-colors shadow-lg">Webé€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ã‚‹æ™‚ã«é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆè¦æ¨©é™ï¼‰</p>
            </div>
            <div>
              <button id="downloadICS" class="w-full px-4 py-3 bg-green-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-green-700 transition-colors shadow-lg">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ï¼ˆICSï¼‰</button>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">æ¯æ—¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã«ç™»éŒ²ï¼ˆæ¨å¥¨ï¼‰</p>
              <div class="mt-3 flex items-center gap-2">
                <label class="text-sm font-medium">æ™‚åˆ»:</label>
                <input type="time" id="reminderTime" value="20:00" class="px-3 py-2 border-2 border-gray-400 dark:border-gray-500 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-medium min-h-[44px] focus:border-primary transition-colors">
              </div>
            </div>
          </div>
        </div>

        <!-- Install -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </h2>
          <div id="installGuide" class="space-y-2">
            <p class="text-sm text-gray-600 dark:text-gray-400"><strong>Android:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã¾ãŸã¯ä¸Šéƒ¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’ä½¿ç”¨</p>
            <p class="text-sm text-gray-600 dark:text-gray-400"><strong>iOS:</strong> Safariã®å…±æœ‰ãƒœã‚¿ãƒ³â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</p>
          </div>
        </div>

        <!-- Backup -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
          <div class="space-y-2">
            <button id="exportJSON" class="w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <label class="block">
              <input type="file" id="importJSON" accept=".json" class="hidden">
              <span class="block w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-center cursor-pointer min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
            </label>
          </div>
        </div>

        <!-- Developer Tools -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <details>
            <summary class="text-lg font-bold cursor-pointer text-gray-800 dark:text-gray-200">ğŸ› ï¸ é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</summary>
            <div class="mt-4 space-y-2">
              <button id="devDateMinus" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-gray-700 transition-colors shadow-md">æ—¥ä»˜ -1æ—¥</button>
              <button id="devDatePlus" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-gray-700 transition-colors shadow-md">æ—¥ä»˜ +1æ—¥</button>
              <button id="devDateReset" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-gray-700 transition-colors shadow-md">æ—¥ä»˜ãƒªã‚»ãƒƒãƒˆ</button>
              <button id="devClearData" class="w-full px-4 py-3 bg-red-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-red-700 transition-colors shadow-md">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </div>
          </details>
        </div>

        <!-- Usage Guide -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ“– ç°¡æ˜“ã®ä½¿ã„æ–¹</h2>
          <div class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
            <p><strong>1. ã‚¿ã‚¤ãƒãƒ¼é¸æŠ:</strong> 5/7/10åˆ†ã‹ã‚‰é¸ã³ã€é–‹å§‹ãƒœã‚¿ãƒ³ã§æ™‚é–“è¨ˆæ¸¬é–‹å§‹</p>
            <p><strong>2. å…¥åŠ›:</strong> æˆæœç›®æ¨™â†’ç¾å®Ÿâ†’ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ+ã§è¿½åŠ ï¼‰â†’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’è¨¼æ‹ â†’ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</p>
            <p><strong>3. ä¿å­˜:</strong> ä¸‹éƒ¨ã®ã€Œä¿å­˜ã—ã¦å®Œäº†ã€ãƒœã‚¿ãƒ³ï¼ˆCmd/Ctrl+S ã§ã‚‚å¯ï¼‰</p>
            <p><strong>4. ç¿’æ…£åŒ–:</strong> é€£ç¶šæ—¥æ•°ï¼ˆStreakï¼‰ã‚’ä¼¸ã°ã—ã¦ãƒãƒƒã‚¸ç²å¾—</p>
            <p><strong>5. å±¥æ­´:</strong> éå»ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ¤œç´¢ãƒ»ç¢ºèªãƒ»ç·¨é›†ãƒ»è¤‡è£½</p>
            <p><strong>6. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³:</strong> PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ</p>
          </div>
        </div>

      </section>
    </div>

  </div>

  <!-- Bottom CTA (Today tab only) -->
  <div id="bottomCTA" class="fixed bottom-16 left-0 right-0 border-t border-gray-200/50 dark:border-gray-700/50 bottom-cta">
    <div class="max-w-2xl mx-auto px-4 py-3">
      <button id="saveBtn" class="w-full py-4 btn-gradient text-white rounded-2xl font-bold text-lg min-h-[56px] shadow-2xl" aria-label="ä¿å­˜ã—ã¦å®Œäº†">
        ğŸ’¾ ä¿å­˜ã—ã¦å®Œäº†
      </button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 border-t border-gray-200/50 dark:border-gray-700/50 bottom-nav">
    <div class="max-w-2xl mx-auto flex justify-around">
      <button data-tab="today" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-primary border-t-2 border-primary" aria-label="ä»Šæ—¥ã‚¿ãƒ–">
        <div class="text-2xl">ğŸ“</div>
        <div class="text-xs mt-1">ä»Šæ—¥</div>
      </button>
      <button data-tab="history" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors" aria-label="å±¥æ­´ã‚¿ãƒ–">
        <div class="text-2xl">ğŸ“š</div>
        <div class="text-xs mt-1">å±¥æ­´</div>
      </button>
      <button data-tab="settings" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors" aria-label="è¨­å®šã‚¿ãƒ–">
        <div class="text-2xl">âš™ï¸</div>
        <div class="text-xs mt-1">è¨­å®š</div>
      </button>
    </div>
  </nav>

  <!-- Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 overflow-y-auto backdrop-blur-sm">
    <div class="min-h-screen px-4 py-8">
      <div class="max-w-2xl mx-auto glass-card rounded-2xl shadow-2xl p-6 modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold gradient-text">è©³ç´°</h2>
          <button id="closeModal" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl min-h-[44px] min-w-[44px] transition-colors text-xl font-bold text-gray-700 dark:text-gray-300" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        </div>
        <div id="detailContent" class="space-y-4 mb-6"></div>
        <div class="flex gap-2 flex-wrap">
          <button id="editEntry" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">ç·¨é›†</button>
          <button id="duplicateEntry" class="px-4 py-2 bg-green-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-green-700 transition-colors shadow-lg">ä»Šæ—¥ã«è¤‡è£½</button>
          <button id="printEntry" class="px-4 py-2 bg-gray-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-gray-700 transition-colors shadow-lg">å°åˆ·</button>
          <button id="deleteEntry" class="px-4 py-2 bg-red-600 text-white rounded-xl font-bold min-h-[44px] hover:bg-red-700 transition-colors shadow-lg">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 glass-card text-gray-900 dark:text-white px-6 py-3 rounded-2xl shadow-2xl z-50" style="top: calc(5rem + env(safe-area-inset-top));"></div>

  <script>
    // ============================================
    // State & Constants
    // ============================================
    const STORAGE_KEY = 'tensionChart.entries.v1'; // Not used anymore
    const DATE_OFFSET_KEY = 'tensionChart.dateOffset';
    const INSTALL_DISMISSED_KEY = 'tensionChart.installDismissed';

    let entries = [];
    let currentEntry = null;
    let currentDetailId = null;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerDuration = 5 * 60; // default 5 min
    let isTimerRunning = false;
    let autoSaveTimeout = null;
    let deferredPrompt = null;
    let dateOffsetDays = 0;
    let currentUser = null; // Current authenticated user
    let isInitialized = false;

    // ============================================
    // Firebase Authentication
    // ============================================
    async function initializeAuth() {
      const { onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } = window.firebaseModules;
      const auth = window.firebaseAuth;

      // â­ FIX: èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã®å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      // ã“ã‚Œã«ã‚ˆã‚Šã€æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ã‚‚ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½ã™ã‚‹
      document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
      document.getElementById('signOutBtn').addEventListener('click', handleSignOut);

      return new Promise((resolve) => {
        onAuthStateChanged(auth, async (user) => {
          // Hide loading screen
          document.getElementById('authLoadingScreen').classList.add('hidden');

          if (user) {
            // User is signed in
            currentUser = user;
            console.log('User signed in:', user.email);

            // Show user info bar
            document.getElementById('userPhoto').src = user.photoURL || '';
            document.getElementById('userName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email || '';
            document.getElementById('userInfoBar').classList.remove('hidden');

            // Hide login screen
            document.getElementById('loginScreen').classList.add('hidden');

            // Initialize app only once
            if (!isInitialized) {
              isInitialized = true;
              await initializeApp();
            }

            resolve(user);
          } else {
            // User is signed out
            currentUser = null;
            console.log('User signed out');

            // Show login screen
            document.getElementById('loginScreen').classList.remove('hidden');

            // Hide user info bar
            document.getElementById('userInfoBar').classList.add('hidden');

            resolve(null);
          }
        });
      });
    }

    async function handleGoogleSignIn() {
      console.log('[Auth] handleGoogleSignIn called');
      console.log('[Auth] Firebase check:', {
        modules: !!window.firebaseModules,
        auth: !!window.firebaseAuth
      });

      const { signInWithPopup, GoogleAuthProvider } = window.firebaseModules;
      const auth = window.firebaseAuth;

      try {
        console.log('[Auth] Creating provider...');
        const provider = new GoogleAuthProvider();
        console.log('[Auth] Calling signInWithPopup...');
        const result = await signInWithPopup(auth, provider);
        console.log('[Auth] Sign in successful:', result.user.email);
      } catch (error) {
        console.error('[Auth] Sign in error:', error);
        showToast('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function handleSignOut() {
      const { signOut } = window.firebaseModules;
      const auth = window.firebaseAuth;

      if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        await signOut(auth);
        showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');

        // Reset app state
        isInitialized = false;
        entries = [];
        currentEntry = null;
      } catch (error) {
        console.error('Sign out error:', error);
        showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // ============================================
    // Utility: Date/Time (Asia/Tokyo)
    // ============================================
    function getTodayString() {
      const offset = parseInt(localStorage.getItem(DATE_OFFSET_KEY) || '0', 10);
      dateOffsetDays = offset;
      const now = new Date();
      now.setDate(now.getDate() + offset);

      const formatter = new Intl.DateTimeFormat('ja-JP', {
        timeZone: 'Asia/Tokyo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const parts = formatter.formatToParts(now);
      const year = parts.find(p => p.type === 'year').value;
      const month = parts.find(p => p.type === 'month').value;
      const day = parts.find(p => p.type === 'day').value;

      return `${year}-${month}-${day}`;
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${y}å¹´${m}æœˆ${d}æ—¥`;
    }

    function getCurrentTimestamp() {
      return new Date().toISOString();
    }

    function daysDiff(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      const diffTime = Math.abs(d2 - d1);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // Firestore CRUD
    // ============================================
    async function loadEntries() {
      if (!currentUser) {
        console.warn('No user authenticated');
        entries = [];
        return;
      }

      try {
        const { collection, getDocs, query, orderBy } = window.firebaseModules;
        const db = window.firebaseDb;

        const entriesRef = collection(db, 'users', currentUser.uid, 'entries');
        const q = query(entriesRef, orderBy('date', 'desc'));
        const querySnapshot = await getDocs(q);

        entries = [];
        querySnapshot.forEach((doc) => {
          entries.push({
            id: doc.id,
            ...doc.data()
          });
        });

        console.log(`Loaded ${entries.length} entries from Firestore`);
      } catch (e) {
        console.error('Failed to load entries:', e);
        showToast('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
        entries = [];
      }
    }

    async function saveEntries() {
      // This function is deprecated in favor of upsertEntry
      // Keep it for backward compatibility but do nothing
      console.log('saveEntries() called - use upsertEntry() instead');
    }

    function findEntryByDate(date) {
      return entries.find(e => e.date === date);
    }

    async function upsertEntry(entry) {
      if (!currentUser) {
        console.error('No user authenticated');
        showToast('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        // Validate entry before saving
        validateEntry(entry);

        const { doc, setDoc } = window.firebaseModules;
        const db = window.firebaseDb;

        // Update local array
        const index = entries.findIndex(e => e.id === entry.id);
        if (index >= 0) {
          entries[index] = entry;
        } else {
          entries.push(entry);
        }

        // Save to Firestore
        const entryRef = doc(db, 'users', currentUser.uid, 'entries', entry.id);
        await setDoc(entryRef, {
          date: entry.date,
          goal: entry.goal,
          reality: entry.reality,
          actions: entry.actions,
          statusNote: entry.statusNote,
          evidence: entry.evidence,
          reflection: entry.reflection,
          createdAt: entry.createdAt,
          updatedAt: entry.updatedAt
        });

        console.log('Entry saved to Firestore:', entry.id);
      } catch (e) {
        console.error('Failed to save entry:', e);
        showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function deleteEntryById(id) {
      if (!currentUser) {
        console.error('No user authenticated');
        showToast('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const { doc, deleteDoc } = window.firebaseModules;
        const db = window.firebaseDb;

        // Update local array
        entries = entries.filter(e => e.id !== id);

        // Delete from Firestore
        const entryRef = doc(db, 'users', currentUser.uid, 'entries', id);
        await deleteDoc(entryRef);

        console.log('Entry deleted from Firestore:', id);
      } catch (e) {
        console.error('Failed to delete entry:', e);
        showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    // ============================================
    // Streak Calculation
    // ============================================
    function calculateStreak() {
      if (entries.length === 0) return { current: 0, max: 0 };

      const sorted = [...entries].sort((a, b) => b.date.localeCompare(a.date));
      const today = getTodayString();

      let current = 0;
      let max = 0;
      let tempStreak = 0;

      // Current streak
      let checkDate = today;
      for (let i = 0; i < sorted.length; i++) {
        if (sorted[i].date === checkDate) {
          current++;
          const prev = new Date(checkDate);
          prev.setDate(prev.getDate() - 1);
          checkDate = prev.toISOString().split('T')[0];
        } else {
          break;
        }
      }

      // Max streak
      for (let i = 0; i < sorted.length; i++) {
        if (i === 0) {
          tempStreak = 1;
        } else {
          const diff = daysDiff(sorted[i].date, sorted[i - 1].date);
          if (diff === 1) {
            tempStreak++;
          } else {
            max = Math.max(max, tempStreak);
            tempStreak = 1;
          }
        }
      }
      max = Math.max(max, tempStreak);

      return { current, max };
    }

    function getStreakBadge(days) {
      if (days >= 30) return '<span class="streak-shimmer text-lg font-bold">ğŸ† 30æ—¥é”æˆ!</span>';
      if (days >= 14) return '<span class="text-yellow-500 font-bold">ğŸ”¥ 2é€±é–“!</span>';
      if (days >= 7) return '<span class="text-orange-500 font-bold">â­ 1é€±é–“!</span>';
      if (days >= 3) return '<span class="text-green-500 font-bold">âœ¨ 3æ—¥ç¶™ç¶š!</span>';
      return '';
    }

    function updateStreakDisplay() {
      const { current, max } = calculateStreak();
      document.getElementById('currentStreak').textContent = `${current}æ—¥`;
      document.getElementById('maxStreak').textContent = `æœ€é•· ${max}æ—¥`;
      document.getElementById('streakBadge').innerHTML = getStreakBadge(current);
    }

    // ============================================
    // Form Management
    // ============================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    async function loadTodayEntry() {
      const today = getTodayString();
      currentEntry = findEntryByDate(today);

      if (!currentEntry) {
        currentEntry = {
          id: generateId(),
          date: today,
          goal: { title: '', detail: '' },
          reality: '',
          actions: [],
          statusNote: '',
          evidence: '',
          reflection: '',
          createdAt: getCurrentTimestamp(),
          updatedAt: getCurrentTimestamp()
        };
      }

      renderForm();
    }

    function renderForm() {
      document.getElementById('goalTitle').value = currentEntry.goal.title || '';
      document.getElementById('goalDetail').value = currentEntry.goal.detail || '';
      document.getElementById('reality').value = currentEntry.reality || '';
      document.getElementById('statusNote').value = currentEntry.statusNote || '';
      document.getElementById('evidence').value = currentEntry.evidence || '';
      document.getElementById('reflection').value = currentEntry.reflection || '';

      renderActions();
    }

    function renderActions() {
      const container = document.getElementById('actionsList');
      container.innerHTML = '';

      currentEntry.actions.forEach((action, index) => {
        const div = document.createElement('div');
        div.className = 'action-item flex items-center gap-2 bg-white/50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-200 dark:border-gray-700';

        // Move buttons container
        const moveButtons = document.createElement('div');
        moveButtons.className = 'flex flex-col gap-1';

        // Move up button
        const upBtn = document.createElement('button');
        upBtn.type = 'button';
        upBtn.textContent = 'â†‘';
        upBtn.className = 'px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-300 dark:border-gray-600 rounded min-h-[20px] min-w-[32px] hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-xs font-bold';
        upBtn.setAttribute('aria-label', 'ä¸Šã«ç§»å‹•');
        upBtn.disabled = index === 0;
        if (index === 0) {
          upBtn.classList.add('opacity-30', 'cursor-not-allowed');
        }
        upBtn.addEventListener('click', () => {
          if (index > 0) {
            // Swap with previous item
            [currentEntry.actions[index - 1], currentEntry.actions[index]] =
            [currentEntry.actions[index], currentEntry.actions[index - 1]];
            renderActions();
            scheduleAutoSave();
          }
        });

        // Move down button
        const downBtn = document.createElement('button');
        downBtn.type = 'button';
        downBtn.textContent = 'â†“';
        downBtn.className = 'px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-gray-300 dark:border-gray-600 rounded min-h-[20px] min-w-[32px] hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-xs font-bold';
        downBtn.setAttribute('aria-label', 'ä¸‹ã«ç§»å‹•');
        downBtn.disabled = index === currentEntry.actions.length - 1;
        if (index === currentEntry.actions.length - 1) {
          downBtn.classList.add('opacity-30', 'cursor-not-allowed');
        }
        downBtn.addEventListener('click', () => {
          if (index < currentEntry.actions.length - 1) {
            // Swap with next item
            [currentEntry.actions[index], currentEntry.actions[index + 1]] =
            [currentEntry.actions[index + 1], currentEntry.actions[index]];
            renderActions();
            scheduleAutoSave();
          }
        });

        moveButtons.appendChild(upBtn);
        moveButtons.appendChild(downBtn);

        const select = document.createElement('select');
        select.className = 'px-2 py-1 border-2 border-gray-400 dark:border-gray-500 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-medium min-h-[44px] focus:border-primary transition-colors';
        select.innerHTML = `
          <option value="todo" ${action.status === 'todo' ? 'selected' : ''}>æœªç€æ‰‹</option>
          <option value="doing" ${action.status === 'doing' ? 'selected' : ''}>é€²è¡Œä¸­</option>
          <option value="done" ${action.status === 'done' ? 'selected' : ''}>å®Œäº†</option>
        `;
        select.addEventListener('change', (e) => {
          currentEntry.actions[index].status = e.target.value;
          scheduleAutoSave();
        });

        const input = document.createElement('input');
        input.type = 'text';
        input.value = action.text;
        input.placeholder = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹';
        input.className = 'flex-1 px-3 py-2 border-2 border-gray-400 dark:border-gray-500 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors';
        input.addEventListener('input', (e) => {
          currentEntry.actions[index].text = e.target.value;
          scheduleAutoSave();
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'âœ•';
        deleteBtn.className = 'px-3 py-2 bg-red-500 text-white rounded-lg min-h-[44px] min-w-[44px] hover:bg-red-600 transition-colors';
        deleteBtn.setAttribute('aria-label', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤');
        deleteBtn.addEventListener('click', () => {
          currentEntry.actions.splice(index, 1);
          renderActions();
          scheduleAutoSave();
        });

        div.appendChild(moveButtons);
        div.appendChild(select);
        div.appendChild(input);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
    }

    function collectFormData() {
      currentEntry.goal = {
        title: document.getElementById('goalTitle').value.trim(),
        detail: document.getElementById('goalDetail').value.trim()
      };
      currentEntry.reality = document.getElementById('reality').value.trim();
      currentEntry.statusNote = document.getElementById('statusNote').value.trim();
      currentEntry.evidence = document.getElementById('evidence').value.trim();
      currentEntry.reflection = document.getElementById('reflection').value.trim();
      currentEntry.updatedAt = getCurrentTimestamp();
    }

    async function saveCurrentEntry() {
      collectFormData();
      await upsertEntry(currentEntry);
      updateStreakDisplay();

      // Vibration
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }

      // Success animation
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.classList.add('success-bounce');
      setTimeout(() => saveBtn.classList.remove('success-bounce'), 500);

      showToast('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function scheduleAutoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        collectFormData();
        // Silent save (no toast)
      }, 3000);
    }

    // ============================================
    // Timer
    // ============================================
    function updateTimerDisplay() {
      const mins = Math.floor(Math.abs(timerSeconds) / 60);
      const secs = Math.abs(timerSeconds) % 60;
      const sign = timerSeconds < 0 ? '-' : '';
      const display = `${sign}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

      // Update both timers
      const timerEl = document.getElementById('timerDisplay');
      const stickyTimerEl = document.getElementById('stickyTimerDisplay');
      timerEl.textContent = display;
      stickyTimerEl.textContent = display;

      // Visual feedback when time is up
      if (timerSeconds <= 0 && isTimerRunning) {
        timerEl.classList.add('pulse-slow', 'text-red-500');
        stickyTimerEl.classList.add('pulse-slow', 'text-red-500');
      } else {
        timerEl.classList.remove('pulse-slow', 'text-red-500');
        stickyTimerEl.classList.remove('pulse-slow', 'text-red-500');
      }
    }

    function startTimer() {
      if (isTimerRunning) return;
      isTimerRunning = true;

      // Update both timer button sets
      document.getElementById('timerStart').classList.add('hidden');
      document.getElementById('timerPause').classList.remove('hidden');
      document.getElementById('stickyTimerStart').classList.add('hidden');
      document.getElementById('stickyTimerPause').classList.remove('hidden');

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();

        // Notify when time is up (once)
        if (timerSeconds === 0) {
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }
          showToast('â° æ™‚é–“ã«ãªã‚Šã¾ã—ãŸï¼å…¥åŠ›ã¯ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚');
        }
      }, 1000);
    }

    function pauseTimer() {
      isTimerRunning = false;
      clearInterval(timerInterval);

      // Update both timer button sets
      document.getElementById('timerStart').classList.remove('hidden');
      document.getElementById('timerPause').classList.add('hidden');
      document.getElementById('stickyTimerStart').classList.remove('hidden');
      document.getElementById('stickyTimerPause').classList.add('hidden');
    }

    function resetTimer() {
      pauseTimer();
      timerSeconds = timerDuration;
      updateTimerDisplay();
    }

    function setTimerDuration(minutes, buttonElement) {
      timerDuration = minutes * 60;
      resetTimer();

      // Update active state
      document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.classList.remove('bg-primary-dark', 'text-white');
        btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white');
      });
      buttonElement.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white');
      buttonElement.classList.add('bg-primary-dark', 'text-white');
    }

    // ============================================
    // History
    // ============================================
    function renderHistory() {
      const container = document.getElementById('historyList');
      const searchTerm = document.getElementById('historySearch').value.toLowerCase();
      const sortOrder = document.getElementById('historySortOrder').value;
      const filter = document.getElementById('historyFilter').value;

      let filtered = [...entries];

      // Search
      if (searchTerm) {
        filtered = filtered.filter(e => {
          const searchStr = JSON.stringify(e).toLowerCase();
          return searchStr.includes(searchTerm);
        });
      }

      // Filter
      if (filter === 'hasDone') {
        filtered = filtered.filter(e => e.actions.some(a => a.status === 'done'));
      }

      // Sort
      filtered.sort((a, b) => {
        return sortOrder === 'desc'
          ? b.date.localeCompare(a.date)
          : a.date.localeCompare(b.date);
      });

      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      filtered.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'glass-card rounded-2xl p-4 shadow-lg cursor-pointer card-hover';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');

        const doneCount = entry.actions.filter(a => a.status === 'done').length;
        const totalActions = entry.actions.length;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">${formatDate(entry.date)}</div>
            <div class="text-sm font-bold text-primary">${doneCount}/${totalActions} å®Œäº†</div>
          </div>
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">${escapeHtml(entry.goal.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰')}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${escapeHtml(entry.statusNote || entry.reality || '')}</p>
        `;

        card.addEventListener('click', () => showDetail(entry.id));
        card.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') showDetail(entry.id);
        });

        container.appendChild(card);
      });
    }

    // ============================================
    // Detail Modal
    // ============================================
    function showDetail(id) {
      const entry = entries.find(e => e.id === id);
      if (!entry) return;

      currentDetailId = id;
      const content = document.getElementById('detailContent');

      content.innerHTML = `
        <div class="border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">${formatDate(entry.date)}</div>
          <h3 class="text-2xl font-bold gradient-text">${escapeHtml(entry.goal.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰')}</h3>
          ${entry.goal.detail ? `<p class="text-gray-700 dark:text-gray-300 mt-2">${escapeHtml(entry.goal.detail)}</p>` : ''}
        </div>

        <div class="space-y-4">
          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“Š</span>
              <span>ç¾å®Ÿ</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${escapeHtml(entry.reality || 'â€”')}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>âœ…</span>
              <span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
            </h4>
            <ul class="space-y-1">
              ${entry.actions.map(a => {
                const icon = a.status === 'done' ? 'âœ…' : a.status === 'doing' ? 'ğŸ”„' : 'â­•';
                return `<li class="flex items-start gap-2"><span>${icon}</span><span>${escapeHtml(a.text)}</span></li>`;
              }).join('') || '<li class="text-gray-500">â€”</li>'}
            </ul>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“</span>
              <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
            </h4>
            <p class="text-gray-900 dark:text-white">${escapeHtml(entry.statusNote || 'â€”')}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“¸</span>
              <span>è¨¼æ‹ ãƒ»ãƒ­ã‚°</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${escapeHtml(entry.evidence || 'â€”')}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ’­</span>
              <span>ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${escapeHtml(entry.reflection || 'â€”')}</p>
          </section>
        </div>
      `;

      document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeDetail() {
      document.getElementById('detailModal').classList.add('hidden');
      currentDetailId = null;
    }

    function editCurrentDetail() {
      const entry = entries.find(e => e.id === currentDetailId);
      if (!entry) return;

      currentEntry = entry;
      renderForm();
      closeDetail();
      navigateToTab('today');
      showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
    }

    function duplicateCurrentDetail() {
      const entry = entries.find(e => e.id === currentDetailId);
      if (!entry) return;

      const today = getTodayString();
      const duplicate = {
        ...entry,
        id: generateId(),
        date: today,
        createdAt: getCurrentTimestamp(),
        updatedAt: getCurrentTimestamp()
      };

      currentEntry = duplicate;
      renderForm();
      closeDetail();
      navigateToTab('today');
      showToast('ä»Šæ—¥ã«è¤‡è£½ã—ã¾ã—ãŸ');
    }

    function printCurrentDetail() {
      window.print();
    }

    async function deleteCurrentDetail() {
      if (!confirm('ã“ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      await deleteEntryById(currentDetailId);
      closeDetail();
      renderHistory();
      updateStreakDisplay();
      showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    // ============================================
    // Navigation
    // ============================================
    function navigateToTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });

      // Show target tab
      const targetTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
      if (targetTab) {
        targetTab.classList.remove('hidden');
      }

      // Update nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-primary', 'border-t-2', 'border-primary');
        btn.classList.add('text-gray-500', 'dark:text-gray-400');
      });
      const activeBtn = document.querySelector(`.nav-btn[data-tab="${tabName}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
        activeBtn.classList.add('text-primary', 'border-t-2', 'border-primary');
      }

      // Show/hide bottom CTA
      if (tabName === 'today') {
        document.getElementById('bottomCTA').classList.remove('hidden');
      } else {
        document.getElementById('bottomCTA').classList.add('hidden');
      }

      // Show/hide sticky timer (only for today tab)
      const stickyTimer = document.getElementById('stickyTimer');
      if (tabName !== 'today') {
        stickyTimer.classList.remove('visible');
      }

      // Update hash
      window.location.hash = tabName;

      // Refresh content
      if (tabName === 'history') {
        renderHistory();
      }
    }

    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'today';
      if (hash.startsWith('detail/')) {
        const id = hash.split('/')[1];
        showDetail(id);
      } else if (['today', 'history', 'settings'].includes(hash)) {
        navigateToTab(hash);
      } else {
        navigateToTab('today');
      }
    }

    // ============================================
    // Export/Import
    // ============================================
    function exportJSON() {
      const dataStr = JSON.stringify(entries, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tension-chart-backup-${getTodayString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) {
            throw new Error('Invalid format');
          }

          // Merge strategy: ask user
          const hasConflicts = imported.some(imp =>
            entries.some(existing => existing.date === imp.date)
          );

          if (hasConflicts) {
            if (!confirm('åŒã˜æ—¥ä»˜ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
              return;
            }
          }

          imported.forEach(imp => {
            const existing = entries.find(e => e.date === imp.date);
            if (existing) {
              // Overwrite
              Object.assign(existing, imp);
            } else {
              entries.push(imp);
            }
          });

          saveEntries();
          renderHistory();
          updateStreakDisplay();
          showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
        } catch (err) {
          console.error('Import error:', err);
          showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸æ­£ã§ã™');
        }
      };
      reader.readAsText(file);
    }

    // ============================================
    // ICS Calendar
    // ============================================
    function generateICS() {
      const time = document.getElementById('reminderTime').value || '20:00';
      const [hour, minute] = time.split(':');

      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tension Chart//Daily Reminder//JP
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:tension-chart-reminder@${Date.now()}
DTSTAMP:${formatICSDate(new Date())}
DTSTART;TZID=Asia/Tokyo:${formatICSDate(new Date(), hour, minute)}
RRULE:FREQ=DAILY
SUMMARY:ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆå…¥åŠ›
DESCRIPTION:ä»Šæ—¥ã®ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ï¼ˆ5ã€œ10åˆ†ï¼‰
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆå…¥åŠ›ã®æ™‚é–“ã§ã™
END:VALARM
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tension-chart-reminder.ics';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„ã€‚');
    }

    function formatICSDate(date, hour = '20', minute = '00') {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}${m}${d}T${hour}${minute}00`;
    }

    // ============================================
    // Notifications
    // ============================================
    async function testNotification() {
      if (!('Notification' in window)) {
        showToast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        return;
      }

      if (Notification.permission === 'granted') {
        new Notification('ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ', {
          body: 'ä»Šæ—¥ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ï¼',
          icon: './icon-192.png',
          badge: './icon-192.png'
        });
        showToast('é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
      } else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          new Notification('ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ', {
            body: 'é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼',
            icon: './icon-192.png'
          });
          showToast('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        } else {
          showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
      } else {
        showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // ============================================
    // PWA Install
    // ============================================
    function showInstallBanner() {
      const dismissed = localStorage.getItem(INSTALL_DISMISSED_KEY);
      if (dismissed) return;

      document.getElementById('installBanner').classList.remove('hidden');
    }

    function hideInstallBanner() {
      document.getElementById('installBanner').classList.add('hidden');
      localStorage.setItem(INSTALL_DISMISSED_KEY, 'true');
    }

    async function triggerInstall() {
      if (!deferredPrompt) {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼');
      }

      deferredPrompt = null;
      hideInstallBanner();
    }

    // ============================================
    // Developer Tools
    // ============================================
    async function adjustDateOffset(days) {
      const current = parseInt(localStorage.getItem(DATE_OFFSET_KEY) || '0', 10);
      const newOffset = current + days;
      localStorage.setItem(DATE_OFFSET_KEY, newOffset.toString());
      dateOffsetDays = newOffset;

      await loadTodayEntry();
      updateStreakDisplay();
      showToast(`æ—¥ä»˜ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${newOffset > 0 ? '+' : ''}${newOffset}æ—¥`);
    }

    async function resetDateOffset() {
      localStorage.removeItem(DATE_OFFSET_KEY);
      dateOffsetDays = 0;
      await loadTodayEntry();
      updateStreakDisplay();
      showToast('æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    async function clearAllData() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

      if (!currentUser) {
        showToast('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        // Delete all entries from Firestore
        for (const entry of entries) {
          await deleteEntryById(entry.id);
        }

        entries = [];
        await loadTodayEntry();
        renderHistory();
        updateStreakDisplay();
        showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('Failed to clear data:', e);
        showToast('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    // ============================================
    // Toast
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    // ============================================
    // Online/Offline (Removed - online-only app)
    // ============================================
    function updateOnlineStatus() {
      // No longer needed for online-only app
      console.log('Online status:', navigator.onLine);
    }

    // ============================================
    // Keyboard Shortcuts
    // ============================================
    function handleKeyboardShortcuts(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        saveCurrentEntry();
      }

      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        saveCurrentEntry();
      }
    }

    // ============================================
    // Event Listeners
    // ============================================
    function setupEventListeners() {
      // Auth buttons
      document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
      document.getElementById('signOutBtn').addEventListener('click', handleSignOut);

      // Navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          navigateToTab(e.currentTarget.dataset.tab);
        });
      });

      // Timer - FIXED: pass button element
      document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const minutes = parseInt(e.target.dataset.timer, 10);
          setTimerDuration(minutes, e.target);
        });
      });
      document.getElementById('timerStart').addEventListener('click', startTimer);
      document.getElementById('timerPause').addEventListener('click', pauseTimer);
      document.getElementById('timerReset').addEventListener('click', resetTimer);

      // Sticky timer buttons
      document.getElementById('stickyTimerStart').addEventListener('click', startTimer);
      document.getElementById('stickyTimerPause').addEventListener('click', pauseTimer);
      document.getElementById('stickyTimerReset').addEventListener('click', resetTimer);

      // Scroll event for sticky timer
      let timerSectionObserver = null;
      const timerSection = document.querySelector('#tabToday section:nth-child(2)'); // Timer section
      const stickyTimer = document.getElementById('stickyTimer');

      if (timerSection && 'IntersectionObserver' in window) {
        timerSectionObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting) {
              // Timer section is out of view, show sticky timer
              stickyTimer.classList.add('visible');
            } else {
              // Timer section is in view, hide sticky timer
              stickyTimer.classList.remove('visible');
            }
          });
        }, {
          threshold: 0,
          rootMargin: '-100px 0px 0px 0px'
        });
        timerSectionObserver.observe(timerSection);
      }

      // Form auto-save
      document.getElementById('chartForm').addEventListener('input', scheduleAutoSave);

      // Actions
      document.getElementById('addAction').addEventListener('click', () => {
        currentEntry.actions.push({
          id: generateId(),
          text: '',
          status: 'todo'
        });
        renderActions();
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveCurrentEntry);

      // History
      document.getElementById('historySearch').addEventListener('input', renderHistory);
      document.getElementById('historySortOrder').addEventListener('change', renderHistory);
      document.getElementById('historyFilter').addEventListener('change', renderHistory);

      // Detail modal
      document.getElementById('closeModal').addEventListener('click', closeDetail);
      document.getElementById('editEntry').addEventListener('click', editCurrentDetail);
      document.getElementById('duplicateEntry').addEventListener('click', duplicateCurrentDetail);
      document.getElementById('printEntry').addEventListener('click', printCurrentDetail);
      document.getElementById('deleteEntry').addEventListener('click', deleteCurrentDetail);

      // Settings
      document.getElementById('testNotification').addEventListener('click', testNotification);
      document.getElementById('downloadICS').addEventListener('click', generateICS);
      document.getElementById('exportJSON').addEventListener('click', exportJSON);
      document.getElementById('importJSON').addEventListener('change', (e) => {
        if (e.target.files[0]) {
          importJSON(e.target.files[0]);
        }
      });

      // Developer tools
      document.getElementById('devDateMinus').addEventListener('click', () => adjustDateOffset(-1));
      document.getElementById('devDatePlus').addEventListener('click', () => adjustDateOffset(1));
      document.getElementById('devDateReset').addEventListener('click', resetDateOffset);
      document.getElementById('devClearData').addEventListener('click', clearAllData);

      // Install banner
      document.getElementById('installBtn').addEventListener('click', triggerInstall);
      document.getElementById('installDismiss').addEventListener('click', hideInstallBanner);

      // Hash navigation
      window.addEventListener('hashchange', handleHashChange);

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);

      // Online/offline
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // PWA install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallBanner();
      });

      // Modal backdrop click
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') {
          closeDetail();
        }
      });
    }

    // ============================================
    // Service Worker Registration
    // ============================================
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('Service Worker registered:', registration);
        } catch (error) {
          console.error('Service Worker registration failed:', error);
        }
      }
    }

    // ============================================
    // Security: HTML Escape Function
    // ============================================
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // Security: Input Validation
    // ============================================
    function validateEntry(entry) {
      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¤œè¨¼
      if (!/^\d{4}-\d{2}-\d{2}$/.test(entry.date)) {
        throw new Error('Invalid date format');
      }

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã®åˆ¶é™
      if (entry.actions.length > 50) {
        throw new Error('Too many actions');
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•åˆ¶é™ï¼ˆ10KBï¼‰
      const maxLength = 10000;
      const fields = [
        entry.goal?.title,
        entry.goal?.detail,
        entry.reality,
        entry.statusNote,
        entry.evidence,
        entry.reflection
      ];

      for (const field of fields) {
        if (field && field.length > maxLength) {
          throw new Error('Text too long');
        }
      }

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      for (const action of entry.actions) {
        if (!action.text || typeof action.text !== 'string') {
          throw new Error('Invalid action text');
        }
        if (action.text.length > maxLength) {
          throw new Error('Action text too long');
        }
        if (!['todo', 'doing', 'done'].includes(action.status)) {
          throw new Error('Invalid action status');
        }
      }

      return true;
    }

    // ============================================
    // Initialization
    // ============================================
    async function initializeApp() {
      await loadEntries();
      await loadTodayEntry();
      updateStreakDisplay();
      updateTimerDisplay();
      setupEventListeners();
      handleHashChange();
      updateOnlineStatus();
      registerServiceWorker();

      // Set default timer to 5 min
      const defaultBtn = document.querySelector('.timer-btn[data-timer="5"]');
      if (defaultBtn) {
        setTimerDuration(5, defaultBtn);
      }
    }

    // ============================================
    // Initialization - Firebaseæº–å‚™å®Œäº†ã‚’å¾…ã¤
    // ============================================

    async function waitForFirebase() {
      return new Promise((resolve) => {
        if (window.firebaseReady) {
          console.log('[App] Firebase already ready');
          resolve();
        } else {
          console.log('[App] Waiting for Firebase...');
          window.addEventListener('firebaseReady', () => {
            console.log('[App] Firebase ready event received');
            resolve();
          }, { once: true });
        }
      });
    }

    async function startApp() {
      console.log('[App] Starting application...');

      await waitForFirebase();

      console.log('[App] Firebase modules available:', {
        auth: !!window.firebaseAuth,
        db: !!window.firebaseDb,
        modules: !!window.firebaseModules
      });

      await initializeAuth();
    }

    // Start app
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
  </script>
</body>
</html>
