<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>æ—¥æ¬¡ ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ</title>

  <!-- PWA Meta -->
  <meta name="description" content="ãƒ¢ãƒã‚¤ãƒ«ã§æ¯æ—¥5ã€œ10åˆ†ã®å…¥åŠ›â†’ä¿å­˜â†’ç¿’æ…£åŒ–ã€‚ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆã§ç›®æ¨™é”æˆã‚’å¯è¦–åŒ–ã€‚">
  <meta name="theme-color" content="#6366F1">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- iOS Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ç·Šå¼µæ§‹é€ ">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Tailwind Config */
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#6366F1',
              dark: '#4F46E5',
              light: '#818CF8'
            },
            accent: {
              DEFAULT: '#EC4899',
              dark: '#DB2777',
              light: '#F472B6'
            }
          }
        }
      }
    }

    /* Custom Styles */
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      overscroll-behavior-y: contain;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      }
    }

    /* App Container with frosted glass effect */
    #appContainer {
      backdrop-filter: blur(10px);
    }

    /* Focus visible for accessibility */
    *:focus-visible {
      outline: 2px solid #6366F1;
      outline-offset: 2px;
    }

    /* Bottom Navigation safe area */
    .bottom-nav {
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }

    @media (prefers-color-scheme: dark) {
      .bottom-nav {
        background: rgba(17, 24, 39, 0.95);
      }
    }

    /* Bottom CTA safe area */
    .bottom-cta {
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }

    @media (prefers-color-scheme: dark) {
      .bottom-cta {
        background: rgba(17, 24, 39, 0.95);
      }
    }

    /* Card with frosted glass */
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @media (prefers-color-scheme: dark) {
      .glass-card {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
    }

    /* Timer animation */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .pulse-slow {
      animation: pulse-slow 2s ease-in-out infinite;
    }

    /* Success animation */
    @keyframes success-bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .success-bounce {
      animation: success-bounce 0.5s ease-in-out;
    }

    /* Streak badge shimmer */
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    .streak-shimmer {
      background: linear-gradient(90deg, #fbbf24 0%, #fcd34d 50%, #fbbf24 100%);
      background-size: 200% auto;
      animation: shimmer 2s linear infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @media (prefers-color-scheme: dark) {
      .gradient-text {
        background: linear-gradient(135deg, #818CF8 0%, #C084FC 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
    }

    /* Button gradient */
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }

    .btn-gradient:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .btn-gradient:active {
      transform: translateY(0);
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    /* Smooth scroll for modals */
    .modal-content {
      scroll-behavior: smooth;
    }

    /* Action item drag handle */
    .action-item {
      touch-action: pan-y;
      transition: all 0.2s ease;
    }

    .action-item:hover {
      transform: translateX(4px);
    }

    /* Card hover effect */
    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    /* Timer ring */
    .timer-ring {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    }

    @media (prefers-color-scheme: dark) {
      .timer-ring {
        background: linear-gradient(135deg, #818CF8 0%, #C084FC 100%);
      }
    }
  </style>
</head>
<body class="text-gray-900 dark:text-gray-100 min-h-screen pb-20">

  <!-- Install Banner -->
  <div id="installBanner" class="hidden fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-primary to-accent text-white p-4 shadow-lg" style="padding-top: calc(1rem + env(safe-area-inset-top));">
    <div class="flex items-center justify-between max-w-md mx-auto">
      <div class="flex-1">
        <p class="text-sm font-medium">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦å¿«é©ã«ä½¿ã†</p>
      </div>
      <button id="installBtn" class="ml-4 px-4 py-2 bg-white text-primary rounded-lg font-medium text-sm min-h-[44px] hover:bg-gray-100 transition-colors">è¿½åŠ </button>
      <button id="installDismiss" class="ml-2 p-2 min-h-[44px] min-w-[44px] hover:bg-white/20 rounded-lg transition-colors" aria-label="é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </div>

  <!-- Offline Banner -->
  <div id="offlineBanner" class="hidden fixed top-0 left-0 right-0 z-40 bg-yellow-500 text-gray-900 p-2 text-center text-sm font-medium" style="padding-top: calc(0.5rem + env(safe-area-inset-top));">
    âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ - ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿
  </div>

  <!-- Main Content Container -->
  <div id="appContainer" class="max-w-2xl mx-auto">

    <!-- Tab: Today -->
    <div id="tabToday" class="tab-content p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text mb-3">ä»Šæ—¥ã®ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ</h1>
        <div id="streakDisplay" class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2 bg-primary/10 dark:bg-primary/20 px-3 py-1.5 rounded-full">
            <span class="text-xl">ğŸ”¥</span>
            <span id="currentStreak" class="font-bold text-primary">0æ—¥</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full">
            <span class="text-xl">ğŸ†</span>
            <span id="maxStreak" class="font-medium text-gray-600 dark:text-gray-400">æœ€é•· 0æ—¥</span>
          </div>
          <span id="streakBadge" class="ml-auto"></span>
        </div>
      </header>

      <!-- Timer Section -->
      <section class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</h2>
          <div class="flex gap-2">
            <button data-timer="5" class="timer-btn px-4 py-2 rounded-xl text-sm font-medium bg-gray-100 dark:bg-gray-700 hover:bg-primary hover:text-white transition-all min-h-[44px]">5åˆ†</button>
            <button data-timer="7" class="timer-btn px-4 py-2 rounded-xl text-sm font-medium bg-gray-100 dark:bg-gray-700 hover:bg-primary hover:text-white transition-all min-h-[44px]">7åˆ†</button>
            <button data-timer="10" class="timer-btn px-4 py-2 rounded-xl text-sm font-medium bg-gray-100 dark:bg-gray-700 hover:bg-primary hover:text-white transition-all min-h-[44px]">10åˆ†</button>
          </div>
        </div>
        <div class="text-center">
          <div class="timer-ring mx-auto mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-full w-[180px] h-[180px] flex items-center justify-center">
              <div id="timerDisplay" class="text-5xl font-bold text-gray-900 dark:text-white">--:--</div>
            </div>
          </div>
          <div class="flex gap-2 justify-center">
            <button id="timerStart" class="px-6 py-3 bg-primary text-white rounded-xl font-medium min-h-[44px] hover:bg-primary-dark transition-colors shadow-lg">é–‹å§‹</button>
            <button id="timerPause" class="hidden px-6 py-3 bg-yellow-500 text-white rounded-xl font-medium min-h-[44px] hover:bg-yellow-600 transition-colors shadow-lg">ä¸€æ™‚åœæ­¢</button>
            <button id="timerReset" class="px-6 py-3 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded-xl font-medium min-h-[44px] hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">â€»ã‚¿ã‚¤ãƒãƒ¼ã¯ç›®å®‰ã§ã™ã€‚æ™‚é–“ã‚’è¶…éã—ã¦ã‚‚å…¥åŠ›ã¯ç¶šã‘ã‚‰ã‚Œã¾ã™</p>
        </div>
      </section>

      <!-- Form -->
      <form id="chartForm" class="space-y-4">

        <!-- Goal -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ¯</span>
            <span>æˆæœç›®æ¨™</span>
          </label>
          <input type="text" id="goalTitle" placeholder="ä½•ã‚’é”æˆã—ãŸã„ã‹ï¼ˆçŸ­æ–‡ï¼‰" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="æˆæœç›®æ¨™ã‚¿ã‚¤ãƒˆãƒ«">
          <textarea id="goalDetail" rows="2" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰" class="w-full mt-2 px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="æˆæœç›®æ¨™è©³ç´°"></textarea>
        </section>

        <!-- Reality -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“Š</span>
            <span>ç¾å®Ÿ</span>
          </label>
          <textarea id="reality" rows="3" placeholder="ä»Šã®çŠ¶æ³ã¯ï¼Ÿ" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="ç¾å®Ÿ"></textarea>
        </section>

        <!-- Actions -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <div class="flex items-center justify-between mb-3">
            <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300">
              <span class="text-xl">âœ…</span>
              <span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
            </label>
            <button type="button" id="addAction" class="px-4 py-2 bg-primary text-white rounded-xl text-sm font-medium min-h-[44px] hover:bg-primary-dark transition-colors shadow-lg" aria-label="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ">+ è¿½åŠ </button>
          </div>
          <div id="actionsList" class="space-y-2"></div>
        </section>

        <!-- Status Note -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“</span>
            <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
          </label>
          <input type="text" id="statusNote" placeholder="é€²æ—çŠ¶æ³ã®ãƒ¡ãƒ¢" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
        </section>

        <!-- Evidence -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ“¸</span>
            <span>è¨¼æ‹ ãƒ»ãƒ­ã‚°</span>
          </label>
          <textarea id="evidence" rows="2" placeholder="å®Ÿè¡Œã—ãŸè¨¼æ‹ ã‚„ãƒ­ã‚°" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="è¨¼æ‹ ãƒ»ãƒ­ã‚°"></textarea>
        </section>

        <!-- Reflection -->
        <section class="glass-card rounded-2xl p-5 shadow-lg">
          <label class="flex items-center gap-2 text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
            <span class="text-xl">ğŸ’­</span>
            <span>ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„ï¼‰</span>
          </label>
          <textarea id="reflection" rows="3" placeholder="æŒ¯ã‚Šè¿”ã‚Šãƒ»æ°—ã¥ã" class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-primary transition-colors" aria-label="ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³"></textarea>
        </section>

      </form>
    </div>

    <!-- Tab: History -->
    <div id="tabHistory" class="tab-content hidden p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text mb-4">ğŸ“š å±¥æ­´</h1>
        <div class="space-y-2">
          <input type="text" id="historySearch" placeholder="ğŸ” æ¤œç´¢..." class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="å±¥æ­´æ¤œç´¢">
          <div class="flex gap-2">
            <select id="historySortOrder" class="flex-1 px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="ä¸¦ã³é †">
              <option value="desc">æ–°ã—ã„é †</option>
              <option value="asc">å¤ã„é †</option>
            </select>
            <select id="historyFilter" class="flex-1 px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-[44px] focus:border-primary transition-colors" aria-label="ãƒ•ã‚£ãƒ«ã‚¿">
              <option value="all">ã™ã¹ã¦</option>
              <option value="hasDone">å®Œäº†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ã‚Š</option>
            </select>
          </div>
        </div>
      </header>
      <div id="historyList" class="space-y-3"></div>
    </div>

    <!-- Tab: Settings -->
    <div id="tabSettings" class="tab-content hidden p-4 pb-32">
      <header class="mb-6 glass-card rounded-2xl p-6 shadow-lg">
        <h1 class="text-3xl font-bold gradient-text">âš™ï¸ è¨­å®š</h1>
      </header>

      <section class="space-y-4">

        <!-- Reminder -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h2>
          <div class="space-y-3">
            <div>
              <button id="testNotification" class="w-full px-4 py-3 bg-primary text-white rounded-xl font-medium min-h-[44px] hover:bg-primary-dark transition-colors shadow-lg">Webé€šçŸ¥ãƒ†ã‚¹ãƒˆ</button>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ã‚‹æ™‚ã«é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆè¦æ¨©é™ï¼‰</p>
            </div>
            <div>
              <button id="downloadICS" class="w-full px-4 py-3 bg-green-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-green-700 transition-colors shadow-lg">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ ï¼ˆICSï¼‰</button>
              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">æ¯æ—¥ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã«ç™»éŒ²ï¼ˆæ¨å¥¨ï¼‰</p>
              <div class="mt-3 flex items-center gap-2">
                <label class="text-sm font-medium">æ™‚åˆ»:</label>
                <input type="time" id="reminderTime" value="20:00" class="px-3 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 min-h-[44px] focus:border-primary transition-colors">
              </div>
            </div>
          </div>
        </div>

        <!-- Install -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </h2>
          <div id="installGuide" class="space-y-2">
            <p class="text-sm text-gray-600 dark:text-gray-400"><strong>Android:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã¾ãŸã¯ä¸Šéƒ¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’ä½¿ç”¨</p>
            <p class="text-sm text-gray-600 dark:text-gray-400"><strong>iOS:</strong> Safariã®å…±æœ‰ãƒœã‚¿ãƒ³â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</p>
          </div>
        </div>

        <!-- Backup -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
          <div class="space-y-2">
            <button id="exportJSON" class="w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <label class="block">
              <input type="file" id="importJSON" accept=".json" class="hidden">
              <span class="block w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-medium text-center cursor-pointer min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
            </label>
          </div>
        </div>

        <!-- Developer Tools -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <details>
            <summary class="text-lg font-bold cursor-pointer text-gray-800 dark:text-gray-200">ğŸ› ï¸ é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</summary>
            <div class="mt-4 space-y-2">
              <button id="devDateMinus" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-gray-700 transition-colors">æ—¥ä»˜ -1æ—¥</button>
              <button id="devDatePlus" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-gray-700 transition-colors">æ—¥ä»˜ +1æ—¥</button>
              <button id="devDateReset" class="w-full px-4 py-3 bg-gray-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-gray-700 transition-colors">æ—¥ä»˜ãƒªã‚»ãƒƒãƒˆ</button>
              <button id="devClearData" class="w-full px-4 py-3 bg-red-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-red-700 transition-colors">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </div>
          </details>
        </div>

        <!-- Usage Guide -->
        <div class="glass-card rounded-2xl p-5 shadow-lg">
          <h2 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ“– ç°¡æ˜“ã®ä½¿ã„æ–¹</h2>
          <div class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
            <p><strong>1. ã‚¿ã‚¤ãƒãƒ¼é¸æŠ:</strong> 5/7/10åˆ†ã‹ã‚‰é¸ã³ã€é–‹å§‹ãƒœã‚¿ãƒ³ã§æ™‚é–“è¨ˆæ¸¬é–‹å§‹</p>
            <p><strong>2. å…¥åŠ›:</strong> æˆæœç›®æ¨™â†’ç¾å®Ÿâ†’ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ+ã§è¿½åŠ ï¼‰â†’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’è¨¼æ‹ â†’ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</p>
            <p><strong>3. ä¿å­˜:</strong> ä¸‹éƒ¨ã®ã€Œä¿å­˜ã—ã¦å®Œäº†ã€ãƒœã‚¿ãƒ³ï¼ˆCmd/Ctrl+S ã§ã‚‚å¯ï¼‰</p>
            <p><strong>4. ç¿’æ…£åŒ–:</strong> é€£ç¶šæ—¥æ•°ï¼ˆStreakï¼‰ã‚’ä¼¸ã°ã—ã¦ãƒãƒƒã‚¸ç²å¾—</p>
            <p><strong>5. å±¥æ­´:</strong> éå»ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ¤œç´¢ãƒ»ç¢ºèªãƒ»ç·¨é›†ãƒ»è¤‡è£½</p>
            <p><strong>6. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³:</strong> PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ</p>
          </div>
        </div>

      </section>
    </div>

  </div>

  <!-- Bottom CTA (Today tab only) -->
  <div id="bottomCTA" class="fixed bottom-16 left-0 right-0 border-t border-gray-200/50 dark:border-gray-700/50 bottom-cta">
    <div class="max-w-2xl mx-auto px-4 py-3">
      <button id="saveBtn" class="w-full py-4 btn-gradient text-white rounded-2xl font-bold text-lg min-h-[56px] shadow-2xl" aria-label="ä¿å­˜ã—ã¦å®Œäº†">
        ğŸ’¾ ä¿å­˜ã—ã¦å®Œäº†
      </button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 border-t border-gray-200/50 dark:border-gray-700/50 bottom-nav">
    <div class="max-w-2xl mx-auto flex justify-around">
      <button data-tab="today" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-primary border-t-2 border-primary" aria-label="ä»Šæ—¥ã‚¿ãƒ–">
        <div class="text-2xl">ğŸ“</div>
        <div class="text-xs mt-1">ä»Šæ—¥</div>
      </button>
      <button data-tab="history" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors" aria-label="å±¥æ­´ã‚¿ãƒ–">
        <div class="text-2xl">ğŸ“š</div>
        <div class="text-xs mt-1">å±¥æ­´</div>
      </button>
      <button data-tab="settings" class="nav-btn flex-1 py-3 text-center min-h-[56px] font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors" aria-label="è¨­å®šã‚¿ãƒ–">
        <div class="text-2xl">âš™ï¸</div>
        <div class="text-xs mt-1">è¨­å®š</div>
      </button>
    </div>
  </nav>

  <!-- Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 overflow-y-auto backdrop-blur-sm">
    <div class="min-h-screen px-4 py-8">
      <div class="max-w-2xl mx-auto glass-card rounded-2xl shadow-2xl p-6 modal-content">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold gradient-text">è©³ç´°</h2>
          <button id="closeModal" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl min-h-[44px] min-w-[44px] transition-colors" aria-label="é–‰ã˜ã‚‹">âœ•</button>
        </div>
        <div id="detailContent" class="space-y-4 mb-6"></div>
        <div class="flex gap-2 flex-wrap">
          <button id="editEntry" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-blue-700 transition-colors shadow-lg">ç·¨é›†</button>
          <button id="duplicateEntry" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-green-700 transition-colors shadow-lg">ä»Šæ—¥ã«è¤‡è£½</button>
          <button id="printEntry" class="px-4 py-2 bg-gray-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-gray-700 transition-colors shadow-lg">å°åˆ·</button>
          <button id="deleteEntry" class="px-4 py-2 bg-red-600 text-white rounded-xl font-medium min-h-[44px] hover:bg-red-700 transition-colors shadow-lg">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 glass-card text-gray-900 dark:text-white px-6 py-3 rounded-2xl shadow-2xl z-50" style="top: calc(5rem + env(safe-area-inset-top));"></div>

  <script>
    // ============================================
    // State & Constants
    // ============================================
    const STORAGE_KEY = 'tensionChart.entries.v1';
    const DATE_OFFSET_KEY = 'tensionChart.dateOffset';
    const INSTALL_DISMISSED_KEY = 'tensionChart.installDismissed';

    let entries = [];
    let currentEntry = null;
    let currentDetailId = null;
    let timerInterval = null;
    let timerSeconds = 0;
    let timerDuration = 5 * 60; // default 5 min
    let isTimerRunning = false;
    let autoSaveTimeout = null;
    let deferredPrompt = null;
    let dateOffsetDays = 0;

    // ============================================
    // Utility: Date/Time (Asia/Tokyo)
    // ============================================
    function getTodayString() {
      const offset = parseInt(localStorage.getItem(DATE_OFFSET_KEY) || '0', 10);
      dateOffsetDays = offset;
      const now = new Date();
      now.setDate(now.getDate() + offset);

      const formatter = new Intl.DateTimeFormat('ja-JP', {
        timeZone: 'Asia/Tokyo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const parts = formatter.formatToParts(now);
      const year = parts.find(p => p.type === 'year').value;
      const month = parts.find(p => p.type === 'month').value;
      const day = parts.find(p => p.type === 'day').value;

      return `${year}-${month}-${day}`;
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${y}å¹´${m}æœˆ${d}æ—¥`;
    }

    function getCurrentTimestamp() {
      return new Date().toISOString();
    }

    function daysDiff(date1, date2) {
      const d1 = new Date(date1);
      const d2 = new Date(date2);
      const diffTime = Math.abs(d2 - d1);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    // ============================================
    // LocalStorage CRUD
    // ============================================
    function loadEntries() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          entries = JSON.parse(data);
        }
      } catch (e) {
        console.error('Failed to load entries:', e);
        showToast('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¦ãã ã•ã„ã€‚');
        entries = [];
      }
    }

    function saveEntries() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
      } catch (e) {
        console.error('Failed to save entries:', e);
        if (e.name === 'QuotaExceededError') {
          showToast('å®¹é‡ä¸è¶³ã€‚å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
        } else {
          showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
        }
      }
    }

    function findEntryByDate(date) {
      return entries.find(e => e.date === date);
    }

    function upsertEntry(entry) {
      const index = entries.findIndex(e => e.id === entry.id);
      if (index >= 0) {
        entries[index] = entry;
      } else {
        entries.push(entry);
      }
      saveEntries();
    }

    function deleteEntryById(id) {
      entries = entries.filter(e => e.id !== id);
      saveEntries();
    }

    // ============================================
    // Streak Calculation
    // ============================================
    function calculateStreak() {
      if (entries.length === 0) return { current: 0, max: 0 };

      const sorted = [...entries].sort((a, b) => b.date.localeCompare(a.date));
      const today = getTodayString();

      let current = 0;
      let max = 0;
      let tempStreak = 0;

      // Current streak
      let checkDate = today;
      for (let i = 0; i < sorted.length; i++) {
        if (sorted[i].date === checkDate) {
          current++;
          const prev = new Date(checkDate);
          prev.setDate(prev.getDate() - 1);
          checkDate = prev.toISOString().split('T')[0];
        } else {
          break;
        }
      }

      // Max streak
      for (let i = 0; i < sorted.length; i++) {
        if (i === 0) {
          tempStreak = 1;
        } else {
          const diff = daysDiff(sorted[i].date, sorted[i - 1].date);
          if (diff === 1) {
            tempStreak++;
          } else {
            max = Math.max(max, tempStreak);
            tempStreak = 1;
          }
        }
      }
      max = Math.max(max, tempStreak);

      return { current, max };
    }

    function getStreakBadge(days) {
      if (days >= 30) return '<span class="streak-shimmer text-lg font-bold">ğŸ† 30æ—¥é”æˆ!</span>';
      if (days >= 14) return '<span class="text-yellow-500 font-bold">ğŸ”¥ 2é€±é–“!</span>';
      if (days >= 7) return '<span class="text-orange-500 font-bold">â­ 1é€±é–“!</span>';
      if (days >= 3) return '<span class="text-green-500 font-bold">âœ¨ 3æ—¥ç¶™ç¶š!</span>';
      return '';
    }

    function updateStreakDisplay() {
      const { current, max } = calculateStreak();
      document.getElementById('currentStreak').textContent = `${current}æ—¥`;
      document.getElementById('maxStreak').textContent = `æœ€é•· ${max}æ—¥`;
      document.getElementById('streakBadge').innerHTML = getStreakBadge(current);
    }

    // ============================================
    // Form Management
    // ============================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function loadTodayEntry() {
      const today = getTodayString();
      currentEntry = findEntryByDate(today);

      if (!currentEntry) {
        currentEntry = {
          id: generateId(),
          date: today,
          goal: { title: '', detail: '' },
          reality: '',
          actions: [],
          statusNote: '',
          evidence: '',
          reflection: '',
          createdAt: getCurrentTimestamp(),
          updatedAt: getCurrentTimestamp()
        };
      }

      renderForm();
    }

    function renderForm() {
      document.getElementById('goalTitle').value = currentEntry.goal.title || '';
      document.getElementById('goalDetail').value = currentEntry.goal.detail || '';
      document.getElementById('reality').value = currentEntry.reality || '';
      document.getElementById('statusNote').value = currentEntry.statusNote || '';
      document.getElementById('evidence').value = currentEntry.evidence || '';
      document.getElementById('reflection').value = currentEntry.reflection || '';

      renderActions();
    }

    function renderActions() {
      const container = document.getElementById('actionsList');
      container.innerHTML = '';

      currentEntry.actions.forEach((action, index) => {
        const div = document.createElement('div');
        div.className = 'action-item flex items-center gap-2 bg-white/50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-200 dark:border-gray-700';

        const select = document.createElement('select');
        select.className = 'px-2 py-1 border-2 border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 min-h-[44px] focus:border-primary transition-colors';
        select.innerHTML = `
          <option value="todo" ${action.status === 'todo' ? 'selected' : ''}>æœªç€æ‰‹</option>
          <option value="doing" ${action.status === 'doing' ? 'selected' : ''}>é€²è¡Œä¸­</option>
          <option value="done" ${action.status === 'done' ? 'selected' : ''}>å®Œäº†</option>
        `;
        select.addEventListener('change', (e) => {
          currentEntry.actions[index].status = e.target.value;
          scheduleAutoSave();
        });

        const input = document.createElement('input');
        input.type = 'text';
        input.value = action.text;
        input.placeholder = 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…å®¹';
        input.className = 'flex-1 px-3 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 min-h-[44px] focus:border-primary transition-colors';
        input.addEventListener('input', (e) => {
          currentEntry.actions[index].text = e.target.value;
          scheduleAutoSave();
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = 'âœ•';
        deleteBtn.className = 'px-3 py-2 bg-red-500 text-white rounded-lg min-h-[44px] min-w-[44px] hover:bg-red-600 transition-colors';
        deleteBtn.setAttribute('aria-label', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤');
        deleteBtn.addEventListener('click', () => {
          currentEntry.actions.splice(index, 1);
          renderActions();
          scheduleAutoSave();
        });

        div.appendChild(select);
        div.appendChild(input);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
    }

    function collectFormData() {
      currentEntry.goal = {
        title: document.getElementById('goalTitle').value.trim(),
        detail: document.getElementById('goalDetail').value.trim()
      };
      currentEntry.reality = document.getElementById('reality').value.trim();
      currentEntry.statusNote = document.getElementById('statusNote').value.trim();
      currentEntry.evidence = document.getElementById('evidence').value.trim();
      currentEntry.reflection = document.getElementById('reflection').value.trim();
      currentEntry.updatedAt = getCurrentTimestamp();
    }

    function saveCurrentEntry() {
      collectFormData();
      upsertEntry(currentEntry);
      updateStreakDisplay();

      // Vibration
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }

      // Success animation
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.classList.add('success-bounce');
      setTimeout(() => saveBtn.classList.remove('success-bounce'), 500);

      showToast('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function scheduleAutoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        collectFormData();
        // Silent save (no toast)
      }, 3000);
    }

    // ============================================
    // Timer
    // ============================================
    function updateTimerDisplay() {
      const mins = Math.floor(Math.abs(timerSeconds) / 60);
      const secs = Math.abs(timerSeconds) % 60;
      const sign = timerSeconds < 0 ? '-' : '';
      const display = `${sign}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      const timerEl = document.getElementById('timerDisplay');
      timerEl.textContent = display;

      // Visual feedback when time is up
      if (timerSeconds <= 0 && isTimerRunning) {
        timerEl.classList.add('pulse-slow', 'text-red-500');
      } else {
        timerEl.classList.remove('pulse-slow', 'text-red-500');
      }
    }

    function startTimer() {
      if (isTimerRunning) return;
      isTimerRunning = true;

      document.getElementById('timerStart').classList.add('hidden');
      document.getElementById('timerPause').classList.remove('hidden');

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();

        // Notify when time is up (once)
        if (timerSeconds === 0) {
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }
          showToast('â° æ™‚é–“ã«ãªã‚Šã¾ã—ãŸï¼å…¥åŠ›ã¯ç¶šã‘ã‚‰ã‚Œã¾ã™ã€‚');
        }
      }, 1000);
    }

    function pauseTimer() {
      isTimerRunning = false;
      clearInterval(timerInterval);

      document.getElementById('timerStart').classList.remove('hidden');
      document.getElementById('timerPause').classList.add('hidden');
    }

    function resetTimer() {
      pauseTimer();
      timerSeconds = timerDuration;
      updateTimerDisplay();
    }

    function setTimerDuration(minutes, buttonElement) {
      timerDuration = minutes * 60;
      resetTimer();

      // Update active state
      document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-100', 'dark:bg-gray-700');
      });
      buttonElement.classList.remove('bg-gray-100', 'dark:bg-gray-700');
      buttonElement.classList.add('bg-primary', 'text-white');
    }

    // ============================================
    // History
    // ============================================
    function renderHistory() {
      const container = document.getElementById('historyList');
      const searchTerm = document.getElementById('historySearch').value.toLowerCase();
      const sortOrder = document.getElementById('historySortOrder').value;
      const filter = document.getElementById('historyFilter').value;

      let filtered = [...entries];

      // Search
      if (searchTerm) {
        filtered = filtered.filter(e => {
          const searchStr = JSON.stringify(e).toLowerCase();
          return searchStr.includes(searchTerm);
        });
      }

      // Filter
      if (filter === 'hasDone') {
        filtered = filtered.filter(e => e.actions.some(a => a.status === 'done'));
      }

      // Sort
      filtered.sort((a, b) => {
        return sortOrder === 'desc'
          ? b.date.localeCompare(a.date)
          : a.date.localeCompare(b.date);
      });

      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      filtered.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'glass-card rounded-2xl p-4 shadow-lg cursor-pointer card-hover';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');

        const doneCount = entry.actions.filter(a => a.status === 'done').length;
        const totalActions = entry.actions.length;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-2">
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">${formatDate(entry.date)}</div>
            <div class="text-sm font-bold text-primary">${doneCount}/${totalActions} å®Œäº†</div>
          </div>
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">${entry.goal.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰'}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${entry.statusNote || entry.reality || ''}</p>
        `;

        card.addEventListener('click', () => showDetail(entry.id));
        card.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') showDetail(entry.id);
        });

        container.appendChild(card);
      });
    }

    // ============================================
    // Detail Modal
    // ============================================
    function showDetail(id) {
      const entry = entries.find(e => e.id === id);
      if (!entry) return;

      currentDetailId = id;
      const content = document.getElementById('detailContent');

      content.innerHTML = `
        <div class="border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">${formatDate(entry.date)}</div>
          <h3 class="text-2xl font-bold gradient-text">${entry.goal.title || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰'}</h3>
          ${entry.goal.detail ? `<p class="text-gray-700 dark:text-gray-300 mt-2">${entry.goal.detail}</p>` : ''}
        </div>

        <div class="space-y-4">
          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“Š</span>
              <span>ç¾å®Ÿ</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${entry.reality || 'â€”'}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>âœ…</span>
              <span>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
            </h4>
            <ul class="space-y-1">
              ${entry.actions.map(a => {
                const icon = a.status === 'done' ? 'âœ…' : a.status === 'doing' ? 'ğŸ”„' : 'â­•';
                return `<li class="flex items-start gap-2"><span>${icon}</span><span>${a.text}</span></li>`;
              }).join('') || '<li class="text-gray-500">â€”</li>'}
            </ul>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“</span>
              <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
            </h4>
            <p class="text-gray-900 dark:text-white">${entry.statusNote || 'â€”'}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ“¸</span>
              <span>è¨¼æ‹ ãƒ»ãƒ­ã‚°</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${entry.evidence || 'â€”'}</p>
          </section>

          <section>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
              <span>ğŸ’­</span>
              <span>ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</span>
            </h4>
            <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${entry.reflection || 'â€”'}</p>
          </section>
        </div>
      `;

      document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeDetail() {
      document.getElementById('detailModal').classList.add('hidden');
      currentDetailId = null;
    }

    function editCurrentDetail() {
      const entry = entries.find(e => e.id === currentDetailId);
      if (!entry) return;

      currentEntry = entry;
      renderForm();
      closeDetail();
      navigateToTab('today');
      showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
    }

    function duplicateCurrentDetail() {
      const entry = entries.find(e => e.id === currentDetailId);
      if (!entry) return;

      const today = getTodayString();
      const duplicate = {
        ...entry,
        id: generateId(),
        date: today,
        createdAt: getCurrentTimestamp(),
        updatedAt: getCurrentTimestamp()
      };

      currentEntry = duplicate;
      renderForm();
      closeDetail();
      navigateToTab('today');
      showToast('ä»Šæ—¥ã«è¤‡è£½ã—ã¾ã—ãŸ');
    }

    function printCurrentDetail() {
      window.print();
    }

    function deleteCurrentDetail() {
      if (!confirm('ã“ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      deleteEntryById(currentDetailId);
      closeDetail();
      renderHistory();
      updateStreakDisplay();
      showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    // ============================================
    // Navigation
    // ============================================
    function navigateToTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });

      // Show target tab
      const targetTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
      if (targetTab) {
        targetTab.classList.remove('hidden');
      }

      // Update nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-primary', 'border-t-2', 'border-primary');
        btn.classList.add('text-gray-500', 'dark:text-gray-400');
      });
      const activeBtn = document.querySelector(`.nav-btn[data-tab="${tabName}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
        activeBtn.classList.add('text-primary', 'border-t-2', 'border-primary');
      }

      // Show/hide bottom CTA
      if (tabName === 'today') {
        document.getElementById('bottomCTA').classList.remove('hidden');
      } else {
        document.getElementById('bottomCTA').classList.add('hidden');
      }

      // Update hash
      window.location.hash = tabName;

      // Refresh content
      if (tabName === 'history') {
        renderHistory();
      }
    }

    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'today';
      if (hash.startsWith('detail/')) {
        const id = hash.split('/')[1];
        showDetail(id);
      } else if (['today', 'history', 'settings'].includes(hash)) {
        navigateToTab(hash);
      } else {
        navigateToTab('today');
      }
    }

    // ============================================
    // Export/Import
    // ============================================
    function exportJSON() {
      const dataStr = JSON.stringify(entries, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tension-chart-backup-${getTodayString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) {
            throw new Error('Invalid format');
          }

          // Merge strategy: ask user
          const hasConflicts = imported.some(imp =>
            entries.some(existing => existing.date === imp.date)
          );

          if (hasConflicts) {
            if (!confirm('åŒã˜æ—¥ä»˜ã®ã‚¨ãƒ³ãƒˆãƒªãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
              return;
            }
          }

          imported.forEach(imp => {
            const existing = entries.find(e => e.date === imp.date);
            if (existing) {
              // Overwrite
              Object.assign(existing, imp);
            } else {
              entries.push(imp);
            }
          });

          saveEntries();
          renderHistory();
          updateStreakDisplay();
          showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
        } catch (err) {
          console.error('Import error:', err);
          showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸æ­£ã§ã™');
        }
      };
      reader.readAsText(file);
    }

    // ============================================
    // ICS Calendar
    // ============================================
    function generateICS() {
      const time = document.getElementById('reminderTime').value || '20:00';
      const [hour, minute] = time.split(':');

      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tension Chart//Daily Reminder//JP
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:tension-chart-reminder@${Date.now()}
DTSTAMP:${formatICSDate(new Date())}
DTSTART;TZID=Asia/Tokyo:${formatICSDate(new Date(), hour, minute)}
RRULE:FREQ=DAILY
SUMMARY:ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆå…¥åŠ›
DESCRIPTION:ä»Šæ—¥ã®ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ï¼ˆ5ã€œ10åˆ†ï¼‰
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆå…¥åŠ›ã®æ™‚é–“ã§ã™
END:VALARM
END:VEVENT
END:VCALENDAR`;

      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tension-chart-reminder.ics';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã§é–‹ã„ã¦ãã ã•ã„ã€‚');
    }

    function formatICSDate(date, hour = '20', minute = '00') {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}${m}${d}T${hour}${minute}00`;
    }

    // ============================================
    // Notifications
    // ============================================
    async function testNotification() {
      if (!('Notification' in window)) {
        showToast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        return;
      }

      if (Notification.permission === 'granted') {
        new Notification('ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ', {
          body: 'ä»Šæ—¥ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¾ã—ã‚‡ã†ï¼',
          icon: './icon-192.png',
          badge: './icon-192.png'
        });
        showToast('é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
      } else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          new Notification('ç·Šå¼µæ§‹é€ ãƒãƒ£ãƒ¼ãƒˆ', {
            body: 'é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼',
            icon: './icon-192.png'
          });
          showToast('é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        } else {
          showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
      } else {
        showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // ============================================
    // PWA Install
    // ============================================
    function showInstallBanner() {
      const dismissed = localStorage.getItem(INSTALL_DISMISSED_KEY);
      if (dismissed) return;

      document.getElementById('installBanner').classList.remove('hidden');
    }

    function hideInstallBanner() {
      document.getElementById('installBanner').classList.add('hidden');
      localStorage.setItem(INSTALL_DISMISSED_KEY, 'true');
    }

    async function triggerInstall() {
      if (!deferredPrompt) {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼');
      }

      deferredPrompt = null;
      hideInstallBanner();
    }

    // ============================================
    // Developer Tools
    // ============================================
    function adjustDateOffset(days) {
      const current = parseInt(localStorage.getItem(DATE_OFFSET_KEY) || '0', 10);
      const newOffset = current + days;
      localStorage.setItem(DATE_OFFSET_KEY, newOffset.toString());
      dateOffsetDays = newOffset;

      loadTodayEntry();
      updateStreakDisplay();
      showToast(`æ—¥ä»˜ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${newOffset > 0 ? '+' : ''}${newOffset}æ—¥`);
    }

    function resetDateOffset() {
      localStorage.removeItem(DATE_OFFSET_KEY);
      dateOffsetDays = 0;
      loadTodayEntry();
      updateStreakDisplay();
      showToast('æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }

    function clearAllData() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

      localStorage.removeItem(STORAGE_KEY);
      entries = [];
      loadTodayEntry();
      renderHistory();
      updateStreakDisplay();
      showToast('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }

    // ============================================
    // Toast
    // ============================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');

      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    // ============================================
    // Online/Offline
    // ============================================
    function updateOnlineStatus() {
      const banner = document.getElementById('offlineBanner');
      if (!navigator.onLine) {
        banner.classList.remove('hidden');
      } else {
        banner.classList.add('hidden');
      }
    }

    // ============================================
    // Keyboard Shortcuts
    // ============================================
    function handleKeyboardShortcuts(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        saveCurrentEntry();
      }

      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        saveCurrentEntry();
      }
    }

    // ============================================
    // Event Listeners
    // ============================================
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          navigateToTab(e.currentTarget.dataset.tab);
        });
      });

      // Timer - FIXED: pass button element
      document.querySelectorAll('.timer-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const minutes = parseInt(e.target.dataset.timer, 10);
          setTimerDuration(minutes, e.target);
        });
      });
      document.getElementById('timerStart').addEventListener('click', startTimer);
      document.getElementById('timerPause').addEventListener('click', pauseTimer);
      document.getElementById('timerReset').addEventListener('click', resetTimer);

      // Form auto-save
      document.getElementById('chartForm').addEventListener('input', scheduleAutoSave);

      // Actions
      document.getElementById('addAction').addEventListener('click', () => {
        currentEntry.actions.push({
          id: generateId(),
          text: '',
          status: 'todo'
        });
        renderActions();
      });

      // Save button
      document.getElementById('saveBtn').addEventListener('click', saveCurrentEntry);

      // History
      document.getElementById('historySearch').addEventListener('input', renderHistory);
      document.getElementById('historySortOrder').addEventListener('change', renderHistory);
      document.getElementById('historyFilter').addEventListener('change', renderHistory);

      // Detail modal
      document.getElementById('closeModal').addEventListener('click', closeDetail);
      document.getElementById('editEntry').addEventListener('click', editCurrentDetail);
      document.getElementById('duplicateEntry').addEventListener('click', duplicateCurrentDetail);
      document.getElementById('printEntry').addEventListener('click', printCurrentDetail);
      document.getElementById('deleteEntry').addEventListener('click', deleteCurrentDetail);

      // Settings
      document.getElementById('testNotification').addEventListener('click', testNotification);
      document.getElementById('downloadICS').addEventListener('click', generateICS);
      document.getElementById('exportJSON').addEventListener('click', exportJSON);
      document.getElementById('importJSON').addEventListener('change', (e) => {
        if (e.target.files[0]) {
          importJSON(e.target.files[0]);
        }
      });

      // Developer tools
      document.getElementById('devDateMinus').addEventListener('click', () => adjustDateOffset(-1));
      document.getElementById('devDatePlus').addEventListener('click', () => adjustDateOffset(1));
      document.getElementById('devDateReset').addEventListener('click', resetDateOffset);
      document.getElementById('devClearData').addEventListener('click', clearAllData);

      // Install banner
      document.getElementById('installBtn').addEventListener('click', triggerInstall);
      document.getElementById('installDismiss').addEventListener('click', hideInstallBanner);

      // Hash navigation
      window.addEventListener('hashchange', handleHashChange);

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboardShortcuts);

      // Online/offline
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // PWA install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallBanner();
      });

      // Modal backdrop click
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') {
          closeDetail();
        }
      });
    }

    // ============================================
    // Service Worker Registration
    // ============================================
    async function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('./sw.js');
          console.log('Service Worker registered:', registration);
        } catch (error) {
          console.error('Service Worker registration failed:', error);
        }
      }
    }

    // ============================================
    // Initialization
    // ============================================
    function init() {
      loadEntries();
      loadTodayEntry();
      updateStreakDisplay();
      updateTimerDisplay();
      setupEventListeners();
      handleHashChange();
      updateOnlineStatus();
      registerServiceWorker();

      // Set default timer to 5 min
      const defaultBtn = document.querySelector('.timer-btn[data-timer="5"]');
      if (defaultBtn) {
        setTimerDuration(5, defaultBtn);
      }
    }

    // Start app
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
